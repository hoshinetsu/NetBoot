<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="robots" content="noindex, nofollow, noimageindex, nosnippet">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="author" content="hoshinetsu">
    <meta name="description" content="a wake-on-lan tool. coded for Emcheratti ‚ò∫">
    <!-- kuba hasioku spasiony w dupe se tego burpa wsadz! -->
    <link rel="stylesheet" href="lib/bootstrap.min.css">
    <link rel="shortcut icon" href="favicon.ico">
    <title>netboot ver. c1.1 | emc</title>
    <style>
        /* custom bootstrap theme here 'cause who needs sass */
        @keyframes bodybgcolor {
            0% {
                background-color: #002200;
            }

            33% {
                background-color: #003300;
            }

            66% {
                background-color: #004400;
            }

            100% {
                background-color: #005500;
            }
        }

        body {
            background-color: #005500;
            background-image: url('img/bg-tiles.png');
            background-size: cover;
            animation-name: bodybgcolor;
            animation-duration: 8s;
            animation-iteration-count: infinite;
            animation-direction: alternate-reverse;
        }

        header,
        footer {
            background-color: #111;
            color: #44AA00;
        }

        header {
            border-bottom: 2px solid #005500;
        }

        footer {
            border-top: 2px solid #005500;
        }

        main {
            border: 2px solid #005500;
            background-color: #111;
        }

        .th-header-top {
            font-family: Georgia, 'Times New Roman', Times, serif;
        }

        .th-header-bot {
            font-family: 'Courier New', Courier, monospace;
            letter-spacing: 2px;
            text-indent: 2px;
        }

        .th-fit {
            width: fit-content;
        }

        .th-form {
            background-color: #222;
            border-radius: 8px;
        }

        .th-ptr {
            cursor: pointer;
        }

        .status-log {
            color: #ccc;
        }

        .status-red {
            color: #CC0000;
            font-size: 1.15rem;
            font-weight: bold;
        }

        .status-green {
            color: #44AA00;
            font-size: 1.15rem;
            font-weight: bold;
        }
    </style>
</head>

<body data-bs-theme="dark" class="vh-100 d-flex flex-column justify-content-start" onload="init()">
    <header class="d-flex flex-row justify-content-center mb-5 pt-3 pb-1">
        <div>
            <h2 class="th-header-top text-center mb-0">Wake That Chungus</h2>
            <h4 class="th-fit th-header-bot mx-auto">like it's 9/11</h4>
        </div>
    </header>
    <main class="container p-3 ">
        <div class="row justify-content-center">
            <div class="col-xs-12 fadein">
                <legend class="text-center text-danger">Authorizzation required üêÄ</legend>
                <p class="text-center">I apologize, but I have to make sure its not the <b>kuba</b> guy <br>whom I told
                    that he can shove his <i>hacking tools</i> right up his ass</p>
            </div>
        </div>
        <div class="row justify-content-center">
            <div class="col-xs-12 col-lg-8 col-xl-6">
                <div class="fadein">
                    <form action="javascript:parseForm()" method="post" class="th-form p-3">
                        <label for="user">Your name (yes the 'cutified' one)</label>
                        <input type="text" required id="user" class="form-control" autofocus oninput="storeField()">
                        <label class="mt-2" for="pass">Password (in meow language)</label>
                        <div class="input-group">
                            <input type="password" required id="pass" class="form-control" oninput="storeField()">
                            <div class="input-group-append">
                                <label class="input-group-text th-ptr">
                                    <input class="th-ptr" type="checkbox" id="hide" checked
                                        onchange="toggleKey()">&nbsp;Hide</label>
                            </div>
                        </div>
                        <div class="mt-3 text-center">
                            <input type="reset" class="btn btn-outline-danger mx-1" value="Clear" id="clear">
                            <input type="submit" class="btn btn-success mx-1" value="Wake that Chungus!" id="wake"
                                disabled>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </main>
    <div class="modal fade" id="actionModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h1 class="modal-title fs-5" id="actionModalLabel">Waking up the Chungus</h1>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" id="actionModalClose"
                        disabled></button>
                </div>
                <div class="modal-body">
                    <p class="text-center my-0">
                        <img src="img/oia-uia.gif" alt="uiia" id="progress">
                    </p>
                    <p class="text-center my-0" id="status"></p>
                </div>
            </div>
        </div>
    </div>
    <script type="text/javascript">
        function getId(id) {
            return document.getElementById(id);
        }

        function getLs(ls) {
            return localStorage.getItem(ls)
        }

        function setLs(k, v) {
            localStorage.setItem(k, v);
        }

        function checkIfFilled(value) {
            return value != null && value.trim().length > 0;
        }

        function toggleButtons(on) {
            if (on) {
                getId("wake").removeAttribute("disabled");
            } else {
                getId("wake").setAttribute("disabled", "da");
            }
        }

        function storeField() {
            let allFilled = true;
            document.querySelectorAll("[required]").forEach(element => {
                if (checkIfFilled(element.value)) {
                    setLs(element.id, element.value);
                } else {
                    allFilled = false;
                }
            });
            toggleButtons(allFilled);
        }

        function restoreSaved() {
            let allFilled = true;
            document.querySelectorAll("[required]").forEach(element => {
                let cache = getLs(element.id);
                if (checkIfFilled(cache)) {
                    element.value = cache;
                } else {
                    allFilled = false;
                }
            });
            toggleButtons(allFilled);
        }

        function toggleKey() {
            let pass = getId("pass");
            if (getId("hide").checked) {
                pass.setAttribute("type", "password");
            } else {
                pass.setAttribute("type", "text");
            }
        }

        const REQ_PING = 10;
        const REQ_WAKE = 11;

        function setStatusColor(stat, color) {
            let status = getId("status");
            status.innerHTML = status.innerHTML + `<span class="status-${color}">` + stat + "</span><br>";
        }

        function setStatus(stat) {
            setStatusColor(stat, "log");
        }

        function hideProgress() {
            getId("progress").setAttribute("style", "display:none");
            getId("actionModalClose").removeAttribute("disabled");
        }

        function showProgress() {
            getId("status").textContent = "";
            getId("progress").removeAttribute("style");
            getId("actionModalClose").setAttribute("disabled", "da");
        }

        function interpretError(q, ans) {
            hideProgress();
            setStatusColor("error: " + ans, "red");
        }

        function interpretResponse(q, ans, recurrence) {
            console.log("Recurrence depth: ", recurrence);
            if (recurrence > 5) {
                setStatus("Abortion!");
                interpretError(0, "too many failed attempts");
                return;
            }
            switch (q) {
                case REQ_PING: {
                    let isUp = Number.parseInt(ans) == 1;
                    setStatus("chungus is " + (isUp ? "UP" : "DOWN"));
                    if (isUp) {
                        hideProgress();
                        setStatusColor("The PC is up on the network. Try parsecing!", "green");
                    } else {
                        sendRequest(REQ_WAKE, ++recurrence);
                    }
                    break;
                }
                case REQ_WAKE: {
                    let wolSent = Number.parseInt(ans) == 1;
                    setStatus("Magic Packet has been" + (wolSent ? " " : " NOT ") + "sent.");
                    if (wolSent) {
                        setStatus("Waiting 10 seconds for the PC to come online..");
                        setTimeout(function () {
                            sendRequest(REQ_PING, recurrence);
                        }, 10000);
                    } else {
                        setStatus("Send failed. Contact your donkey admin!");
                    }
                    break;
                }
                default: {
                    break;
                }
            }
        }

        function sendRequest(q, recurrence = 0) {
            let user = getId("user").value;
            let pass = getId("pass").value;

            let xhr = new XMLHttpRequest();
            xhr.open("GET", `api/auth.php?user=${user}&pass=${pass}&q=${q}`, true);
            xhr.onreadystatechange = function () {
                if (this.readyState == 4) {
                    if (this.status != 200) {
                        interpretError(q, "");
                        return;
                    }
                    let ans = xhr.responseText;
                    if (ans.includes("<out>")) {
                        interpretResponse(q, ans.slice(ans.indexOf("<out>") + 5, ans.indexOf("</out>")), recurrence);
                    } else if (ans.includes("<err>")) {
                        interpretError(q, ans.slice(ans.indexOf("<err>") + 5, ans.indexOf("</err>")));
                    } else {
                        interpretError(q, "server error");
                    }
                }
            }
            xhr.send();
            switch (q) {
                case REQ_PING: {
                    setStatus("pinging the chungus..");
                    break;
                }
                case REQ_WAKE: {
                    setStatus("waking up the chungus..");
                    break;
                }
                default: break;
            }
        }

        function parseForm() {
            showProgress();
            var myModal = new bootstrap.Modal(document.getElementById('actionModal'));
            myModal.show();
            sendRequest(REQ_PING);
        }

        function init() {
            console.log("finished loading.");
            restoreSaved();
        }
    </script>
    <script src="lib/bootstrap.bundle.min.js"></script>
</body>

</html>